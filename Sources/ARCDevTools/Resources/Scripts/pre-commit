#!/bin/bash
# ARCDevTools Pre-commit Hook
# Version: 1.0.0

set -e

echo "ğŸ” Pre-commit: Verificando calidad de cÃ³digo..."

# Detectar archivos Swift staged
STAGED_SWIFT=$(git diff --cached --name-only --diff-filter=ACM | grep ".swift$" || true)

if [ -z "$STAGED_SWIFT" ]; then
  echo "   â„¹ï¸  No hay archivos Swift en stage, omitiendo..."
  exit 0
fi

echo "   ğŸ“ Archivos a verificar:"
echo "$STAGED_SWIFT" | sed 's/^/      - /'

# 1. SwiftFormat (auto-fix)
if command -v swiftformat >/dev/null 2>&1; then
  echo "\n   ğŸ¨ Aplicando SwiftFormat..."
  echo "$STAGED_SWIFT" | xargs swiftformat --config .swiftformat 2>&1 | grep -v "running" || true

  # Re-stage archivos formateados
  echo "$STAGED_SWIFT" | xargs git add
  echo "   âœ“ Formato aplicado"
else
  echo "   âš ï¸  SwiftFormat no instalado (brew install swiftformat)"
fi

# 2. SwiftLint (strict mode)
if command -v swiftlint >/dev/null 2>&1; then
  echo "\n   ğŸ” Ejecutando SwiftLint..."

  if echo "$STAGED_SWIFT" | xargs swiftlint lint --config .swiftlint.yml --strict --quiet; then
    echo "   âœ“ SwiftLint passed"
  else
    echo "\n   âŒ SwiftLint fallÃ³ - Revisa los errores arriba"
    echo "   ğŸ’¡ Tip: Ejecuta 'make lint' para ver detalles"
    exit 1
  fi
else
  echo "   âš ï¸  SwiftLint no instalado (brew install swiftlint)"
fi

echo "\nâœ… Pre-commit completado - Commit permitido"
